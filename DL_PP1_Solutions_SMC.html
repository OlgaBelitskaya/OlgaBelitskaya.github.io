<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>üèôDLPP1SMC</title>
    <script src="https://sagecell.sagemath.org/static/embedded_sagecell.js"></script>
    <script>$(function (){
    sagecell.makeSagecell({inputLocation:'div.linked',linked:true,
                           evalButtonText:'Run Linked Cells'}); });
    </script>
  </head>
  <style>
  @import url('https://fonts.googleapis.com/css?family=Akronim|Lobster');
  h1,h2,th {color:#348ABD; font-family:'Akronim'; font-size:120%; text-shadow:4px 4px 4px #aaa;}
  p,a {color:slategray; font-family:'Lobster'; font-size:120%; text-shadow:4px 4px 4px #aaa;}
  .sagecell .CodeMirror-scroll {min-height:3em; max-height:30em;}
  body {margin:5px 5px 5px 15px;}
  </style>  
  <body>
    <h1>üìë &nbsp; Deep Learning. P1: Neural Networks for Regression</h1>
<a href="https://olgabelitskaya.github.io/README.html">&#x1F300; &nbsp; Home Page &nbsp; &nbsp; &nbsp;</a> 
<a href="https://www.instagram.com/olga.belitskaya/">&#x1F300; &nbsp; Instagram Posts &nbsp; &nbsp; &nbsp;</a>     
<a href="https://www.pinterest.ru/olga_belitskaya/code-style/">&#x1F300; &nbsp; Pinterest Posts</a><br/>
In this project, we'll evaluate the performance and predictive power of neural networks in the sphere of regression tasks.<br/>
Models will be trained and tested on data collected from homes in suburbs of Boston, Massachusetts.<br/>
Origin: This dataset was taken from the StatLib library which is maintained at Carnegie Mellon University.<br/>
Creators: Harrison, D. and Rubinfeld, D.L.<br/>
Data Set Information: Concerns housing values in suburbs of Boston.<br/>
Attribute Information:<br/>
<div class="linked"><script type="text/x-sage">
%%html
<style>
@import url('https://fonts.googleapis.com/css?family=Akronim|Ruthie');
</style>
<table style="width:80%; background-color:black; 
              font-family:Ruthie; font-size:200%;">
<tr style="font-family:Akronim;">
  <th style="color:white;"> Attribute </th>
  <th style="color:white;"> Description </th></tr>
<tr><td style="color:#F898C8;"><center> CRIM </center></td>
<td style="color:#F898C8;"><left>per capita crime rate by town</left></td></tr>
<tr><td style="color:#E91E63;"><center> ZN </center></td>
<td style="color:#E91E63;"><left>proportion of residential 
  land zoned for lots over 25,000 sq.ft.</left></td></tr>
<tr><td style="color:#D62518;"><center> INDUS </center></td>
<td style="color:#D62518;"><left>proportion of non-retail 
  business acres per town</left></td></tr>
<tr><td style="color:#AD0000;"><center> CHAS </center></td>
<td style="color:#AD0000;"><left>Charles River dummy variable 
  (= 1 if tract bounds river; 0 otherwise)</left></td></tr>
<tr><td style="color:#FA7A00;"><center> NOX </center></td>
<td style="color:#FA7A00;"><left>nitric oxides concentration 
  (parts per 10 million)</left></td></tr> 
<tr><td style="color:#FED85D;"><center> RM </center></td>
<td style="color:#FED85D;"><left>average number of rooms 
  per dwelling</left></td></tr> 
  <tr><td style="color:#91E351;"><center> AGE </center></td>
<td style="color:#91E351;"><left>proportion of 
  owner-occupied units built prior to 1940</left></td></tr> 
<tr><td style="color:#00D8A0;"><center> DIS </center></td>
<td style="color:#00D8A0;"><left>weighted distances to 
  five Boston employment centres</left></td></tr> 
<tr><td style="color:#1CAC78;"><center> RAD </center></td>
<td style="color:#1CAC78;"><left>index of accessibility 
  to radial highways</left></td></tr>
  <tr><td style="color:#004C71;"><center> TAX </center></td>
<td style="color:#004C71;"><left>full-value property-tax rate 
  per 10,000 USD</left></td></tr>
<tr><td style="color:#1AADE0;"><center> PTRATIO </center></td>
<td style="color:#1AADE0;"><left>pupil-teacher ratio by town</left></td></tr>
<tr><td style="color:#0069BD;"><center> B </center></td>
<td style="color:#0069BD;"><left>1000(Bk - 0.63)^2 where Bk 
  is the proportion of blacks by town</left></td></tr>
<tr><td style="color:#333399;"><center> LSTAT </center></td>
<td style="color:#333399;"><left>% lower status of the population</left></td></tr> 
<tr><td style="color:#7851A9;"><center> MEDV </center></td>
<td style="color:#7851A9;"><left>Median value of owner-occupied homes 
  in 1000 USD</left></td></tr>
</table>
</script></div><br/>
The Boston housing data was collected in 1978 and each of the <br/>
506 entries represents aggregated data about 14 features for homes from various suburbs.
    <h2>‚úíÔ∏è &nbsp;Step 0. Import Libraries and Define Helpful Functions</h2>      
<div class="linked"><script type="text/x-sage">
#unlock to install modules
#!python3 -m pip install keras --user
#!python3 -m pip install --ignore-installed --upgrade tensorflow==1.14.0
</script></div><br/>
<div class="linked"><script type="text/x-sage">
spath='/home/sc_work/.sage/local/lib/python3.7/site-packages'
import sys; sys.path.append(spath)
import pandas as pd,numpy as np,sqlite3
import seaborn as sn,pylab as pl
import keras as ks,tensorflow as tf
import warnings; warnings.filterwarnings('ignore')
warnings.filterwarnings('ignore',module='tensorflow')
from sklearn.model_selection import train_test_split
from sklearn import datasets
from sklearn.metrics import r2_score
from keras.datasets import boston_housing
from keras.callbacks import ModelCheckpoint,EarlyStopping
from keras.callbacks import ReduceLROnPlateau
from keras.models import Sequential,load_model
from keras.layers import Dense,LSTM,GlobalAveragePooling1D
from keras.layers import Activation,Flatten,Dropout,BatchNormalization
from keras.layers import Conv1D,MaxPooling1D,GlobalMaxPooling1D
from keras.layers.advanced_activations import PReLU,LeakyReLU
</script></div><br/>
<div class="linked"><script type="text/x-sage">
def connect_to_db(dbf):
    sqlconn=None
    try:
        sqlconn=sqlite3.connect(dbf)
        return sqlconn
    except Error as err:
        print(err)
        if sqlconn is not None:
            sqlconn.close()
connection=connect_to_db('boston.db')
if connection is not None:
    cursor=connection.cursor()
</script></div><br/>
<div class="linked"><script type="text/x-sage">
def history_plot(fit_history,n):
    pl.figure(figsize=(10,6))    
    pl.subplot(211)
    pl.plot(fit_history.history['loss'][n:],
            color='slategray',label='train')
    pl.plot(fit_history.history['val_loss'][n:],
            color='#348ABD',label='valid')
    pl.xlabel('Epochs'); pl.ylabel('Loss')
    pl.legend(); pl.title('Loss Function')      
    pl.subplot(212)
    pl.plot(fit_history.history['mean_absolute_error'][n:],
            color='slategray',label='train')
    pl.plot(fit_history.history['val_mean_absolute_error'][n:],
            color='#348ABD',label='valid')
    pl.xlabel('Epochs'); pl.ylabel('MAE')    
    pl.legend(); pl.title('Mean Absolute Error')
    pl.show()
</script></div><br/>
    <h2>‚úíÔ∏è &nbsp;Step 1. Load and Explore the Data</h2> 
<div class="linked"><script type="text/x-sage">
boston_data=datasets.load_boston()
columns=boston_data.feature_names
boston_df=pd.DataFrame(boston_data.data,columns=columns)
boston_df['MEDV']=boston_data.target
boston_df.to_sql('main',con=connection,if_exists='replace')
boston_df.head()
</script></div><br/>
<div class="linked"><script type="text/x-sage">
pearson=boston_df.corr(method='pearson')
corr_with_prices=pearson.iloc[-int(1)][:-int(1)]
pd.DataFrame(corr_with_prices[abs(corr_with_prices)\
             .argsort()[::-int(1)]]).T
</script></div><br/>
<div class="linked"><script type="text/x-sage">
pd.read_sql_query('''
SELECT ZN,
       AVG(LSTAT),
       AVG(RM),
       AVG(PTRATIO),
       AVG(INDUS),
       AVG(TAX)
FROM main
GROUP BY ZN;
''',con=connection)\
.set_index('ZN').head(int(7))
</script></div><br/>
<div class="linked"><script type="text/x-sage">
n=int(51)
(x_train,y_train),(x_test,y_test)=boston_housing.load_data()
x_valid,y_valid=x_test[:n],y_test[:n]
x_test,y_test=x_test[n:],y_test[n:]
t=[["Training feature's shape:",x_train.shape],
   ["Training target's shape",y_train.shape],
   ["Validating feature's shape:",x_valid.shape],
   ["Validating target's shape",y_valid.shape],
   ["Testing feature's shape:",x_test.shape],
   ["Testing target's shape",y_test.shape]]
pd.DataFrame(t)
</script></div><br/>
<div class="linked"><script type="text/x-sage">
pl.style.use('seaborn-whitegrid')
pl.figure(1,figsize=(8,4))
pl.subplot(121)
sn.distplot(y_train,color='#348ABD',bins=30)
pl.ylabel("Distribution"); pl.xlabel("Prices")
pl.subplot(122)
sn.distplot(np.log(y_train),color='#348ABD',bins=30)
pl.ylabel("Distribution"); pl.xlabel("Logarithmic Prices")
pl.suptitle('Boston Housing Data',fontsize=15)
pl.show()
</script></div><br/>
    <h2>‚úíÔ∏è &nbsp;Step 2. Build Neural Networks</h2>
<p>Multilayer Perceptron (MLP)</p><br/>
<div class="linked"><script type="text/x-sage">
def mlp_model():
    model=Sequential() 
    model.add(Dense(1024,activation='relu',input_dim=13))
    model.add(Dense(104,activation='relu'))        
    model.add(Dense(1,kernel_initializer='normal'))   
    model.compile(loss='mse',optimizer='nadam',metrics=['mae'])
    return model
mlp_model=mlp_model() 
</script></div><br/>
<div class="linked"><script type="text/x-sage">
epochs=300; batch_size=64
fw='weights.boston.mlp.hdf5'
mlp_checkpointer=ModelCheckpoint(filepath=fw,verbose=0,
                                 save_best_only=True)
mlp_history=mlp_model.fit(x_train,y_train,batch_size=batch_size, 
                          validation_data=(x_valid,y_valid),
                          epochs=epochs,verbose=0, 
                          callbacks=[mlp_checkpointer])
</script></div><br/>
<div class="linked"><script type="text/x-sage">
history_plot(mlp_history,2)
mlp_model.load_weights(fw)
y_train_mlp=mlp_model.predict(x_train)
y_valid_mlp=mlp_model.predict(x_valid)
y_test_mlp=mlp_model.predict(x_test)
score_train_mlp=r2_score(y_train,y_train_mlp)
score_valid_mlp=r2_score(y_valid,y_valid_mlp)
score_test_mlp=r2_score(y_test,y_test_mlp)
pd.DataFrame([['Train R2 score:',score_train_mlp],
              ['Valid R2 score:',score_valid_mlp],
              ['Test R2 score:',score_test_mlp]])
</script></div><br/>
<div class="linked"><script type="text/x-sage">

</script></div><br/>
<div class="linked"><script type="text/x-sage">

</script></div><br/>
<div class="linked"><script type="text/x-sage">

</script></div><br/>
  </body>
</html>