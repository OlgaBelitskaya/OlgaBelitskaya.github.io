<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>üèôDLPP7SMC</title>
    <script src="https://sagecell.sagemath.org/static/embedded_sagecell.js"></script>
    <script>$(function (){
    sagecell.makeSagecell({inputLocation:'div.linked',linked:true,
                           evalButtonText:'Run Linked Cells'}); });
    </script>
  </head>
  <style>
  @import url('https://fonts.googleapis.com/css?family=Akronim|Lobster');
  h1,h2,th {color:#aa33ff; font-family:'Akronim'; font-size:120%; text-shadow:4px 4px 4px #aaa;}
  p,a,table {color:slategray; font-family:'Lobster'; font-size:120%; text-shadow:4px 4px 4px #aaa;}
  .sagecell .CodeMirror-scroll {min-height:3em; max-height:60em;}
  body {margin:5px 5px 5px 15px;}
  </style>  
  <body>
    <h1>üìë &nbsp; Deep Learning. P7: Horse Breeds' Recognition</h1>
<a href="https://olgabelitskaya.github.io/README.html">&#x1F300; &nbsp; Home Page &nbsp; &nbsp; &nbsp;</a> 
<a href="https://colab.research.google.com/drive/1uB1PuT_uNGM2tv88ZDkIj6Dhi_Rf91PA">
&#x1F300; &nbsp; Google Colaboratory Variant &nbsp; &nbsp; &nbsp;</a> 
<a href="https://www.instagram.com/olga.belitskaya/">&#x1F300; &nbsp; Instagram Posts &nbsp; &nbsp; &nbsp;</a>     
<a href="https://www.pinterest.ru/olga_belitskaya/code-style/">&#x1F300; &nbsp; Pinterest Posts</a><br/>
In this project, we'll classify images from the dataset
<a href="https://www.kaggle.com/olgabelitskaya/horse-breeds">Horse Breeds</a>.<br/>
The content is about 500 images (160x160x3) with 7 horse breeds <br/>
stored in the file <i>HorseBreedImages.h5.zip</i>.<br/>
In the original dataset, photo files are in the .png format and they are labeled by file prefixes.<br/>
<div class="linked"><script type="text/x-sage">
%%html
<table style="width:30%; background-color:silver; 
              font-family:'Lobster'; font-size:150%;">
<tr><th>Label </th><th> Breeds </th></tr>
<tr><td style="color:#FF355E;"><center> 0 </center></td>
<td style="color:#FF355E;"><left> => Akhal-Teke </left></td></tr>
<tr><td style="color:#FF6037;"><center> 1 </center></td>
<td style="color:#FF6037;"><left> => Appaloosa </left></td></tr>
<tr><td style="color:#FF9966;"><center> 2 </center></td>
<td style="color:#FF9966;"><left> => Orlov Trotter </left></td></tr>
<tr><td style="color:#FFCC33;"><center> 3 </center></td>
<td style="color:#FFCC33;"><left> => Vladimir Heavy Draft </left></td></tr> 
<tr><td style="color:#FFFF66;"><center> 4 </center></td>
<td style="color:#FFFF66;"><left> => Percheron </left></td></tr>
<tr><td style="color:#CCFF00;"><center> 5 </center></td>
<td style="color:#CCFF00;"><left> => Arabian </left></td></tr>
<tr><td style="color:#66FF66;"><center> 6 </center></td>
<td style="color:#66FF66;"><left> => Friesian </left></td></tr>
</table>
</script></div><br/>
We'll preprocess the images, then train neural networks.<br/> 
We are going to apply 
<a href="https://keras.io/">Keras: The Python Deep Learning library.</a><br/>
At the end, we'll get to see neural network's predictions on the sample images.<br/>
    <h2>‚úíÔ∏è &nbsp; Step 0. Code Modules & Settings</h2>      
<div class="linked"><script type="text/x-sage">
#unlock to install additional modules
#!python3 -m pip install --ignore-installed --upgrade tensorflow==1.14.0
#!python3 -m pip install torch 
spath='/home/sc_work/.sage/local/lib/python3.7/site-packages'
import sys; sys.path.append(spath)
import warnings; warnings.filterwarnings('ignore')
</script></div><br/>
<div class="linked"><script type="text/x-sage">
import h5py,urllib,torch,zipfile
import tensorflow as tf,pylab as pl
import pandas as pd,numpy as np
import tensorflow.image as timage
from torch.utils.data import DataLoader as tdl
from torch.utils.data import Dataset as tds
from torchvision import transforms,utils,models
import torch.nn.functional as tnnf
import torch.nn as tnn
dev=torch.device("cuda:0" \
if torch.cuda.is_available() else "cpu")
from IPython.core.magic import register_line_magic
</script></div><br/>      
    <h2>‚úíÔ∏è &nbsp; Step 1. Data Loading</h2> 
<div class="linked"><script type="text/x-sage">
path='https://olgabelitskaya.github.io/'
zf='HorseBreedImages.h5.zip'
input_file=urllib.request.urlopen(path+zf)
output_file=open(zf,'wb'); 
output_file.write(input_file.read())
output_file.close(); input_file.close()
zipf=zipfile.ZipFile(zf,'r')
zipf.extractall(''); zipf.close()
f=h5py.File(zf[:-4],'r')
keys=list(f.keys()); print(keys)
</script></div><br/>
    <h2>‚úíÔ∏è &nbsp; Step 2. Data Processing</h2>  
<div class="linked"><script type="text/x-sage">
x_test=np.array(f[keys[0]])
y_test=np.array(f[keys[1]])
x_train=np.array(f[keys[2]])
y_train=np.array(f[keys[3]])
names=['Akhal-Teke','Appaloosa','Orlov Trotter',
       'Vladimir Heavy Draft','Percheron',
       'Arabian','Friesian']
fig=pl.figure(figsize=(10,2))
n=randint(0,y_train.shape[0]-5)
for i in range(n,n+5):
    ax=fig.add_subplot(1,5,i-n+1,\
    xticks=[],yticks=[],\
    title=names[y_train[i]])
    ax.imshow((x_train[i]))
pl.show()
img_size=x_train.shape[2]
n=int(len(x_test)/2)
x_valid,y_valid=x_test[:n],y_test[:n]
x_test,y_test=x_test[n:],y_test[n:]
df=pd.DataFrame([[x_train.shape,x_valid.shape,x_test.shape],
                 [x_train.dtype,x_valid.dtype,x_test.dtype],
                 [y_train.shape,y_valid.shape,y_test.shape],
                 [y_train.dtype,y_valid.dtype,y_test.dtype]],
                 columns=['train','valid','test'],
                 index=["images' shape",'image type',
                        "labels' shape",'label type'])
df
</script></div><br/>
<div class="linked"><script type="text/x-sage">      
class TData(tds):
    def __init__(self,x,y):   
        self.x=torch.tensor(x,dtype=torch.float32)
        self.y=torch.tensor(y,dtype=torch.int32)
    def __getitem__(self,index):
        img,lbl=self.x[index],self.y[index]
        return img,lbl
    def __len__(self):
        return self.y.shape[0]
batch_size2=16; img_size2=64
x_train2=timage.resize(x_train,[img_size2,img_size2])
x_train2=np.transpose(x_train2.numpy(),(0,3,1,2))
print(x_train2.mean(),x_train2.std())
x_valid2=timage.resize(x_valid,[img_size2,img_size2])
x_valid2=np.transpose(x_valid2.numpy(),(0,3,1,2))
x_test2=timage.resize(x_test,[img_size2,img_size2])
x_test2=np.transpose(x_test2.numpy(),(0,3,1,2))
random_seed=23
train2=TData(x_train2,y_train)
valid2=TData(x_valid2,y_valid)
test2=TData(x_test2,y_test)
dataloaders={'train':tdl(dataset=train2,shuffle=True, 
                         batch_size=batch_size2), 
             'valid':tdl(dataset=valid2,shuffle=True, 
                         batch_size=batch_size2),
             'test':tdl(dataset=test2,shuffle=True, 
                        batch_size=batch_size2)}
</script></div><br/>
<div class="linked"><script type="text/x-sage">
@register_line_magic
def display_examples(data):
    for images,labels in dataloaders[data]:  
        print('Image dimensions: %s'%str(images.shape))
        print('Label dimensions: %s'%str(labels.shape))
        n=np.random.randint(1,3)
        fig=pl.figure(figsize=(10,4))
        for i in range(n,n+5):
            ax=fig.add_subplot(1,5,i-n+1,\
            xticks=[],yticks=[],title=names[labels[i].item()])
            ax.imshow(np.transpose(images[i],(1,2,0)))
        break
%display_examples valid
</script></div><br/>
    <h2>‚úíÔ∏è &nbsp; Step 3. </h2>
<div class="linked"><script type="text/x-sage">

</script></div><br/>
<div class="linked"><script type="text/x-sage">

</script></div><br/>      
<div class="linked"><script type="text/x-sage">

</script></div><br/>
    <h2>‚úíÔ∏è &nbsp; Step 4. </h2>
<div class="linked"><script type="text/x-sage">

</script></div><br/>
    <h2>‚úíÔ∏è &nbsp; Step 5. </h2>
<div class="linked"><script type="text/x-sage">

</script></div><br/>
<div class="linked"><script type="text/x-sage">

</script></div><br/>
    <h2>‚úíÔ∏è &nbsp; Step 6. </h2>
<div class="linked"><script type="text/x-sage">

</script></div><br/>
    <h2>‚úíÔ∏è &nbsp; Step 7. </h2>
<div class="linked"><script type="text/x-sage">

</script></div><br/>
  </body>
</html>