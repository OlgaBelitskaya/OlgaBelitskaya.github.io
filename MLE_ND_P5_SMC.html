<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=0.9*device-width">
    <title>MLE_ND_P5_SMC</title>
    <script src="https://sagecell.sagemath.org/static/embedded_sagecell.js"></script>
    <script>$(function () {
    sagecell.makeSagecell({inputLocation:'div.linked',linked:true,evalButtonText:'Run Linked Cells'});  
    sagecell.makeSagecell({inputLocation:'div.sage',evalButtonText:'Run'});
    });
    </script>
  </head>
  <style>
  @import url('https://fonts.googleapis.com/css?family=Orbitron|Roboto');
  body {background-color:#b8e2fc;}; a, p {color:royalblue; font-family:'Roboto';} 
  h1 {color:#191970; font-family:'Orbitron'; text-shadow:4px 4px 4px #ccc;} 
  h2, h3 {color:slategray; font-family:'Orbitron'; text-shadow:4px 4px 4px #ccc;}
  h4 {color:#191970; font-family:'Roboto';}
  .sagecell .CodeMirror-scroll {min-height:3em; max-height:48em;}
  .sagecell table.table_form tr.row-a {background-color:lightgray;} 
  .sagecell table.table_form tr.row-b {background-color:#b8e2fc;}
  .sagecell table.table_form td {padding:5px 15px; color:royalblue; font-family:'Roboto';}
  .sagecell_sessionOutput, .sagecell_sessionOutput pre {color:royalblue; font-family:'Roboto';}
  </style>  
  <body>
    <h1>Machine Learning Engineer Nanodegree</h1>
    <h2>Deep Learning</h2>
    <h1>&#x1F4D1; &nbsp;P5: Build a Digit Recognition Program</h1>
    <h2>Step 0: Load and Create Datasets</h2>      
    <h3>Resources</h3>
<a href="https://scikit-learn.org/stable/index.html">&#x1F578;scikit-learn. Machine Learning in Python&nbsp;</a>
<a href="http://scipy-lectures.org/">&#x1F578;Scipy Lecture Notes&nbsp;</a><br/>
    <h3>Code Library</h3> 
<div class="linked"><script type="text/x-sage">
import numpy,pandas,skimage,pylab,urllib,random; pylab.style.use('seaborn-whitegrid')
import warnings; from sklearn.exceptions import DataConversionWarning
for el in [FutureWarning,UserWarning,DataConversionWarning]: warnings.filterwarnings("ignore",category=el)
from sklearn.model_selection import train_test_split
from sklearn.neural_network import MLPClassifier
from sklearn import datasets,metrics,preprocessing
</script></div>
    <p></p>
<div class="linked"><script type="text/x-sage">
def ohe(x): return preprocessing.OneHotEncoder(categories='auto').fit(x.reshape(-1,1))\
            .transform(x.reshape(-1,1)).toarray().astype('int16')
def sas(X,y): return train_test_split(X,y,test_size=0.2,random_state=1)
def random_rotate(img): return skimage.transform.rotate(img,numpy.random.randint(-20,20))
def label5d(label):
    zeros=numpy.full((5-len(label)),10)
    if len(label) >= 5: return label
    else: return numpy.array(numpy.concatenate((zeros,label),axis=0)).astype('int16')
def concatenate(images,labels,image_size):
    i=0   
    concat_images=numpy.array(numpy.zeros((image_size,image_size*5))).reshape(1,image_size,image_size*5)
    concat_labels=numpy.array(numpy.zeros(5))   
    while i<images.shape[0]:
        if images.shape[0]-i<=5: 
            image=images[i]; label=labels[i]            
            for  j  in range(images.shape[0]-i-1): 
                image=numpy.concatenate((image,images[i+j+1]),axis=1)
                label=numpy.concatenate((label,labels[i+j+1]),axis=0)                
            label=label5d(label); image=skimage.transform.resize(image,(image_size,image_size*5))            
            concat_images=numpy.vstack((concat_images,[image]))
            concat_labels=numpy.vstack((concat_labels,label))           
            i+=5            
        else:
            random_n=numpy.random.randint(3,6); image=images[i]; label=labels[i]           
            for k in range(random_n-1):
                image=numpy.concatenate((image,images[i+k+1]),axis=1)
                label=numpy.concatenate((label,labels[i+k+1]),axis=0)                
            label=label5d(label); image=skimage.transform.resize(image,(image_size,image_size*5))           
            concat_images=numpy.vstack((concat_images,[image]))
            concat_labels=numpy.vstack((concat_labels,label)).astype('int16')           
            i+=random_n            
    concat_images=concat_images[1:]; concat_labels=concat_labels[1:]
    return concat_images,concat_labels
</script></div>
    <p></p> 
    <h3>Experimental Datasets</h3>
<h4>Dataset #1. Scikit-learn. Digits.</h4>
<div class="linked"><script type="text/x-sage">
digits=datasets.load_digits(n_class=10)
X_train1,X_test1,y_train1,y_test1=sas(digits.data,digits.target)
cy_train1=ohe(y_train1); cy_test1=ohe(y_test1)
X_train1.shape,y_train1.shape,X_test1.shape,y_test1.shape
</script></div>
    <p></p>
<div class="linked"><script type="text/x-sage">
n=5; img=numpy.zeros((10*n,10*n))
for i in range(n): 
    for j in range(n): img[(10*i+1):(10*i+9),(10*j+1):(10*j+9)]=X_train1[i*n+j].reshape((8,8))
pylab.figure(figsize=(n,n)); pylab.imshow(img,cmap=pylab.cm.Blues)
pylab.title('Examples of 64-dimensional digits')
pylab.xticks([]); pylab.yticks([]); pylab.show()
print(y_train1[:n*n])
</script></div>
    <p></p> 
<h4>Dataset #2. MNIST</h4>
<div class="linked"><script type="text/x-sage">
path='https://s3.amazonaws.com/img-datasets/'; f='mnist.npz'
input_file=urllib.urlopen(path+f); output_file=open(f,'wb'); output_file.write(input_file.read()) 
input_file.close(); output_file.close(); mnist=numpy.load(f) 
[X_train2,y_train2,X_test2,y_test2]=[mnist[el]for el in ['x_train','y_train','x_test','y_test']]
cy_train2=ohe(y_train2); cy_test2=ohe(y_test2)
X_train2.shape,y_train2.shape,X_test2.shape,y_test2.shape
</script></div>
    <p></p>
<div class="linked"><script type="text/x-sage">
n=5; fig,ax=pylab.subplots(figsize=(n,n+1),nrows=n,ncols=n,sharex=True,sharey=True)
ax=ax.flatten(); [ax[i].imshow(X_train2[i],cmap=pylab.cm.Blues) for i in range(n*n)]
ax[0].set_xticks([]); ax[0].set_yticks([]); pylab.tight_layout(); pylab.gcf() 
ax[2].set_title('Examples of the 784-dimensional digits',fontsize=12); pylab.show()
print(y_train2[:n*n])
</script></div>
    <p></p>
<h4>Dataset #3. Synthetic - Two digits</h4>
<div class="linked"><script type="text/x-sage">
img1=numpy.concatenate((X_train2[20],X_train2[30]),axis=1); zero1=numpy.zeros((14,56))
img2=numpy.concatenate((zero1,img1,zero1),axis=0)
pylab.figure(figsize=(3,4)); pylab.imshow(img2,cmap=pylab.cm.Blues)
pylab.title('Example of two concatenated\n784-dimensional digits')
pylab.xticks([]); pylab.yticks([]); pylab.show()
</script></div>
    <p></p>
<div class="linked"><script type="text/x-sage">
n1,n2=int(X_train2.shape[0]/2),int(X_test2.shape[0]/2); h1=random.randrange(0,28); h2=28-h1
X_train56=[numpy.concatenate((X_train2[:n1][i],X_train2[n1:][i]),axis=1) for i in range(n1)]
X_train56=numpy.array([numpy.concatenate((numpy.zeros((h1,56)),X_train56[i],numpy.zeros((h2,56))),axis=0) for i in range(n1)])
X_test56=[numpy.concatenate((X_test2[:n2][i],X_test2[n2:][i]),axis=1) for i in range(n2)]
X_test56=numpy.array([numpy.concatenate((numpy.zeros((h1,56)),X_test56[i],numpy.zeros((h2,56))),axis=0) for i in range(n2)])
y_train56=numpy.array([numpy.concatenate((y_train2.reshape(-1,1)[:n1][i],y_train2.reshape(-1,1)[n1:][i])) for i in range(n1)])
y_test56=numpy.array([numpy.concatenate((y_test2.reshape(-1,1)[:n2][i],y_test2.reshape(-1,1)[n2:][i])) for i in range(n2)])
k=20; pylab.imshow(X_test56[k],cmap=pylab.cm.Blues); pylab.title('Example of the third dataset')
pylab.show(); print(y_test56[k])
X_train56=X_train56.reshape(-1,1,56,56).astype('float32'); X_test56=X_test56.reshape(-1,1,56,56).astype('float32')
</script></div>
    <p></p>
<h4>Dataset #4. Synthetic. Several digits with rotation</h4>
<div class="linked"><script type="text/x-sage">
X_train2r=numpy.array([random_rotate(image) for image in X_train2])
X_test2r=numpy.array([random_rotate(image) for image in X_test2])
print(y_test2[k]); pylab.imshow(X_test2r[k],cmap=pylab.cm.Blues)
pylab.title('Example of rotation')
pylab.xticks([]); pylab.yticks([]); pylab.show()
</script></div>
    <p></p>
<div class="linked"><script type="text/x-sage">
n=30000
X_train140,y_train140=concatenate(X_train2r[:n],y_train2.reshape(-1,1)[:n],28)
X_test140,y_test140=concatenate(X_test2r[:int(n/5)],y_train2.reshape(-1,1)[:int(n/5)],28)
del X_train2r,X_test2r
print(y_test140[k]); pylab.imshow(X_test140[k],cmap=pylab.cm.Blues)
pylab.title('Example of the final synthetic datasets')
pylab.xticks([]); pylab.yticks([]); pylab.show()
</script></div>
    <p></p>
<div class="linked"><script type="text/x-sage">

</script></div>
    <p></p>
<div class="linked"><script type="text/x-sage">

</script></div>
    <p></p>
<div class="linked"><script type="text/x-sage">

</script></div>
    <p></p>
<div class="linked"><script type="text/x-sage">

</script></div>
    <p></p>
<div class="linked"><script type="text/x-sage">
clf=MLPClassifier(hidden_layer_sizes=(272,),max_iter=5,solver='adam',verbose=0,random_state=1,learning_rate_init=.01)
clf.fit(X_train2.reshape(-1,784),y_train2); print(clf.score(X_test2.reshape(-1,784),y_test2))
y_test2_predictions=clf.predict(X_test2.reshape(-1,784))
pylab.figure(figsize=(12,5)); pylab.scatter(range(100),y_test2[:100],color='#b8e2fc',s=100)
pylab.scatter(range(100),y_test2_predictions[:100],color='#191970',s=25); pylab.show()
</script></div>
    <p></p>
<div class="linked"><script type="text/x-sage">

</script></div>
    <p></p>
<div class="linked"><script type="text/x-sage">

</script></div>
    <p></p>
    <h3>Additional Code Cell</h3>
<div class="linked"><script type="text/x-sage">

</script></div>
    <p></p> 
  </body>
</html>