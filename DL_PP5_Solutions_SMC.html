<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>üèôDLPP5SMC</title>
    <script src="https://sagecell.sagemath.org/static/embedded_sagecell.js"></script>
    <script>$(function (){
    sagecell.makeSagecell({inputLocation:'div.linked',linked:true,
                           evalButtonText:'Run Linked Cells'}); });
    </script>
  </head>
  <style>
  @import url('https://fonts.googleapis.com/css?family=Akronim|Lobster');
  h1,h2,th {color:#348ABD; font-family:'Akronim'; font-size:120%; text-shadow:4px 4px 4px #aaa;}
  p,a {color:slategray; font-family:'Lobster'; font-size:120%; text-shadow:4px 4px 4px #aaa;}
  .sagecell .CodeMirror-scroll {min-height:3em; max-height:30em;}
  body {margin:5px 5px 5px 15px;}
  </style>
  <body>
    <h1>üìë &nbsp; Deep Learning. P5: Decor Recognition & Colorization</h1>
<a href="https://olgabelitskaya.github.io/README.html">&#x1F300; &nbsp; Home Page &nbsp; &nbsp; &nbsp;</a> 
<a href="https://www.instagram.com/olga.belitskaya/">&#x1F300; &nbsp; Instagram Posts &nbsp; &nbsp; &nbsp;</a>     
<a href="https://www.pinterest.ru/olga_belitskaya/code-style/">&#x1F300; &nbsp; Pinterest Posts</a><br/>
    <h2>‚úíÔ∏è &nbsp;Step 0. Import Libraries</h2>      
<div class="linked"><script type="text/x-sage">
#unlock to install modules
#!python3 -m pip install keras --user
#!python3 -m pip install --ignore-installed --upgrade tensorflow==1.14.0
</script></div><br/>
<div class="linked"><script type="text/x-sage">
spath='/home/sc_work/.sage/local/lib/python3.7/site-packages'
import sys; sys.path.append(spath)
import h5py,urllib,zipfile
import pandas as pd,numpy as np,pylab as pl
import seaborn as sn,keras as ks,tensorflow as tf
from skimage.transform import resize
import warnings; warnings.filterwarnings('ignore')
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import OneHotEncoder
np.set_printoptions(precision=6)
pl.style.use('seaborn-whitegrid')
from keras.callbacks import ModelCheckpoint,EarlyStopping
from keras.callbacks import ReduceLROnPlateau
from keras.models import Sequential,load_model,Model
from keras.layers import Input,Activation,Dense,LSTM
from keras.layers import Flatten,Dropout,BatchNormalization
from keras.layers import Conv2D,MaxPooling2D,GlobalMaxPooling2D
from keras.layers.advanced_activations import PReLU,LeakyReLU
from keras import __version__
print('keras version:', __version__)
print('tensorflow version:',tf.__version__)
</script></div><br/>
<div class="linked"><script type="text/x-sage">
fw='weights.style.hdf5'
dr2,dr25,dr3,dr5=\
float(.2),float(.25),float(.3),float(.5)
fr,al=float(.5),float(.02)
[i0,i1,i2,i3,i4,i5]=\
[int(0),int(1),int(2),int(3),int(4),int(5)]
[i7,i8,i10,i12,i16]=\
[int(7),int(8),int(10),int(12),int(16)]
[i20,i32,i48,i50,i64,i96]=\
[int(20),int(32),int(48),int(50),int(64),int(96)]
[i100,i128,i150,i196,i200]=\
[int(100),int(128),int(150),int(196),int(200)]
[i256,i512,i1024]=[int(256),int(512),int(1024)]
</script></div><br/>  
<div class="linked"><script type="text/x-sage">
def ohe(x): 
    return OneHotEncoder(categories='auto')\
           .fit(x.reshape(-i1,i1))\
           .transform(x.reshape(-i1,i1))\
           .toarray().astype('int64')
def tts(X,y): 
    x_train,x_test,y_train,y_test=\
    train_test_split(X,y,test_size=float(.2),
                     random_state=i1)
    n=int(len(x_test)/2)
    x_valid,y_valid=x_test[:n],y_test[:n]
    x_test,y_test=x_test[n:],y_test[n:]
    return x_train,x_valid,x_test,y_train,y_valid,y_test
def resh(x,n):
    y=[resize(el,(int(n),int(n),i3),
              anti_aliasing=True) for el in x]
    return np.array(y)
def resh2(x,n): 
    y=[resize(el,(int(n),int(n),i1),
              anti_aliasing=True) for el in x]
    return np.array(y)
</script></div><br/>
<div class="linked"><script type="text/x-sage">
def history_plot(fit_history):
    pl.figure(figsize=(i10,i10))
    pl.subplot(211)
    pl.plot(fit_history.history['loss'],
            color='slategray',label='train')
    pl.plot(fit_history.history['val_loss'],
            color='#348ABD',label='valid')
    pl.xlabel("Epochs"); pl.ylabel("Loss")
    pl.legend(); pl.grid()
    pl.title('Loss Function')     
    pl.subplot(212)
    pl.plot(fit_history.history['accuracy'],
            color='slategray',label='train')
    pl.plot(fit_history.history['val_accuracy'],
            color='#348ABD',label='valid')
    pl.xlabel("Epochs"); pl.ylabel("Accuracy")    
    pl.legend(); pl.grid()
    pl.title('Accuracy'); pl.show()
</script></div><br/>
    <h2>‚úíÔ∏è &nbsp;Step 1. Load and Explore the Data</h2>
<div class="linked"><script type="text/x-sage">
fpath='https://olgabelitskaya.github.io/'
zf='DecorColorImages.h5.zip'
input_file=urllib.request.urlopen(fpath+zf)
output_file=open(zf,'wb')
output_file.write(input_file.read())
output_file.close(); input_file.close()
zipf=zipfile.ZipFile(zf,'r')
zipf.extractall(''); zipf.close()
f=h5py.File(zf[:-4],'r')
keys=list(f.keys())
[countries,decors,images,types]=\
[np.array(f[keys[i]]) for i in range(4)]
pd.DataFrame([el.shape for el in 
              [countries,decors,images,types]])
</script></div><br/>
<div class="linked"><script type="text/x-sage">
fpath2='https://raw.githubusercontent.com/OlgaBelitskaya/'+\
       'deep_learning_projects/master/DL_PP5/'
data=pd.read_csv(fpath2+'decor.txt')
n=np.random.choice(484,size=6,replace=False)
data.loc[n]
</script></div><br/>
<div class="linked"><script type="text/x-sage">
fig=pl.figure(figsize=(10,4))
for i,idx in enumerate(n):
    ax=fig.add_subplot(2,3,i+1,xticks=[],yticks=[])
    ax.imshow(images[idx]/255)
    ax.set_title(data['country'][idx]+'; '+\
                 data['decor'][idx]+'; '+data['type'][idx])
pl.show()
</script></div><br/>
<div class="linked"><script type="text/x-sage">
gray_images=np.dot(images[...,:3],[.299,.587,.114])
pl.figure(figsize=(3,3))
n=np.random.choice(484,size=1,replace=False)[0]
pl.imshow(images[n])
pl.title(data['country'][n]+'; '+\
         data['decor'][n]+'; '+data['type'][n])
pl.imshow(gray_images[n],cmap=pl.cm.bone); pl.show()
</script></div><br/>
<div class="linked"><script type="text/x-sage">
ccountries,cdecors,ctypes=\
ohe(countries),ohe(decors),ohe(types)
ctargets=np.concatenate((ccountries,cdecors),axis=1)
ctargets=np.concatenate((ctargets,ctypes),axis=1)
images=resh(images); gray_images=gresh(gray_images)
pd.DataFrame([images.shape,gray_images.shape,
              ccountries.shape,cdecors.shape,
              ctypes.shape,ctargets.shape])
</script></div><br/>
<div class="linked"><script type="text/x-sage">
# Color Images / Countries 
x_train1,x_valid1,x_test1,\
y_train1,y_valid1,y_test1=tts(images,ccountries)
# Grayscaled Images / Countries 
x_train2,x_valid2,x_test2,\
y_train2,y_valid2,y_test2=tts(gray_images,ccountries)
# Color Images / Decors 
x_train3,x_valid3,x_test3,\
y_train3,y_valid3,y_test3=tts(images,cdecors)
# Grayscaled Images / Decors 
x_train4,x_valid4,x_test4,\
y_train4,y_valid4,y_test4=tts(gray_images,cdecors)
# Color Images / Multi-Label Targets
x_train5,x_valid5,x_test5,\
y_train5,y_valid5,y_test5=tts(images,ctargets)
# Grayscaled Images / Multi-Label Targets 
x_train6,x_valid6,x_test6,\
y_train6,y_valid6,y_test6=tts(gray_images,ctargets)
sh=[el.shape for el in \
[x_train1,y_train1,x_valid1,y_valid1,x_test1,y_test1,
 x_train3,y_train3,x_valid3,y_valid3,x_test3,y_test3,
 x_train5,y_train5,x_valid5,y_valid5,x_test5,y_test5]]
sh2=[el.shape for el in \
[x_train2,y_train2,x_valid2,y_valid2,x_test2,y_test2,
 x_train4,y_train4,x_valid4,y_valid4,x_test4,y_test4,
 x_train6,y_train6,x_valid6,y_valid6,x_test6,y_test6]]
pd.DataFrame([sh,sh2]).T
</script></div><br/>
<div class="linked"><script type="text/x-sage">

</script></div><br/>
<div class="linked"><script type="text/x-sage">

</script></div><br/>
<div class="linked"><script type="text/x-sage">

</script></div><br/>
<div class="linked"><script type="text/x-sage">

</script></div><br/>
<div class="linked"><script type="text/x-sage">

</script></div><br/>
<div class="linked"><script type="text/x-sage">

</script></div><br/>
  </body>
</html> 